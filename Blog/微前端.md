# 前端也可以搞微服務？！前端最複雜的一種架構

## (一) 原來這是微前端

### 什麼是微前端？

或許你聽過或是沒聽過以下詞彙，「微前端」、「微應用」、「前端微服務」。這些都是相同的東西，後面的文章我都會用「微前端」來稱呼。

你可能聽過微服務，這是已經行之有年的軟體開發架構風格，可以讓單一應用程式有自己的開發、部署、執行的生命週期，透過網路通道來達到相互溝通的能力。微服務是一個很好的切分單位，可以更容易讓更大的團隊溝組織通協作開發。

那什麼是微前端呢？

微前端就是把微服務的架構概念套來前端，將前端需要的模組分散在不同的服務上提供，而不是將所有資訊塞在同一個單體式架構中。所以可能在同一個前端應用程式中，有好幾個儲存庫與分出數個團隊一同開發與維護，並每個團隊都各自管理自己的部分，透過架構去組裝整個應用程式。

### 微前端要解決什麼問題？

會出現一種架構，代表背後就有一個要解決的問題。通常有以下幾種問題時，都可以考量導入微前端來解決當前架構問題。

- 當單一前端專案越來越巨大，已經影響編譯時間與開發效率。
- 單一前端應用需要跨部門多個工程師共同維護，同一個產品已經很進行版本管理。
- 單一產品需要整合多種框架或多種版本共存迭代。
- 有大量需要多專案共用的業務與介面需要外放提供時。

### 微前端的優劣分析

既然產生這種架構必然會產生一些好處，也相對帶來一些壞處。

首先是好處：

- 所有架構各自為政，也可以輕易插拔這些服務元件，首先是解耦。就算特定應用有破壞性損壞，也可以大幅降低對整個應用產生的影響，最壞的情況就是一個微應用為單位崩潰，而不會導致整個應用架構崩潰。
- 再來就是應付大型團隊可以很好的去拆分職責，每個拆出去的 Repository 都可以獨立運行，選用自己想要的技術，並且各自為政不影響運行。
- 因為是單一功能部署，所以 CI/CD 的運行更快完成。
- 因為每一個功能都是基於被拆分的專案去開發，所以沒有超大型專案的維護壓力，只有各自小專案的規模。這樣開發節奏更快速，也可以承受更多工程師同時進行功能開發。

當然，有好處就有壞處：

- 載入的 Application 因為都拆分好幾塊，總體載入程式碼量比較大，通常會消耗更多流量成本
- 功能操作限制多，不能操作 Browser Single State，否則狀態會同步異常，所以需要比較完善的團隊規範
- 使用的函式庫或框架限制多，不能任意選用套件
- 跨微前端溝通方式複雜且麻煩

### 常見的為前端解決方案

要實施微前端有很多解決方案，目前有幾種主流的方法大致上會有幾種。

#### 以 Application 層級來說

- xhr/fetch javascript file to insert in script tag

說穿了就是直接插入 script tag 把 JavaScript 運行起來，注入 global 之中。或是引用單例註冊對象針對行為、元件、模組、資源來供給註冊。

這種方法可簡單可複雜，好壞上下限非常巨大。

- module-federation

使用 webpack 或 vite 提供的 module-federation-plugin 來註冊，它屬於前一種方法的延伸，但提供了完整的解決方案和易懂的操作模式。

但因為吃到了打包體系，webpack 和 vite 並沒有完全通用，進而導致運作會發生異常。採用時必須讓打包工具一致化。

- use micro frontend framework (single-spa, qiankun)

這是最省力的解決方案，事實上這也是基於前面兩種所做的更高階的方法，把維護問題交給套件方。

但同時你失去了微調能力，很多時候在微前端實作在乎的並不是單純實作出微前端，而是各種細膩的優化與調控。

#### 以 Component 層級來說

- iframe

這是最古老最穩定的方法，副作用也是最少的，最不容易發生污染的解決方案。

但這方法的缺點卻也是最多的。
溝通麻煩，需要透過 Dom 取得後由外而內，卻不容易由內而外溝通，跨域時更甚至需要依靠伺服器端來進行溝通。
這方法也同時非常吃資源，它會消耗非常驚人的記憶體和運算資源，沒辦法進行大量掛載。
另外就是 SEO 的扣分，它可能比 CSR 造成的影響更大。

- WebComponent

原生的組件化解決方案，對於各種環境與架構相容性較好。
實體生成與註冊不強制順序，更容易額外封裝。
具備 Shadow DOM 功能，可以隔離 document 的作用域。

優點很多，缺點也不少。
對 SSR 不友善，需要搭配 SSI 相關技術。
拓展功能不如框架的 Component 好用，需要基於 DOM 元件的基礎延伸。
Shadow DOM 也是一把雙面刃，徹底隔離也帶來一些麻煩，後面會額外探討。

- Frontend Framework Component

使用框架的 Component 可以說是幾乎沒有學習成本，使用最直覺。
資料傳遞可以直接依附框架的機制溝通，處理起來更加容易。
建構時也可以大量縮小程式體積，有效降低總程式碼的大小，盡可能重複利用。
對應的 SSR 方案整合度高，容易被實作。

但對於這種解決方案，也有致命問題。
微前端應用被綁定在特定的框架、版本上，當要升版和整合時很容易因為版本不一致損壞。
因為溝通變得容易，元件和元件在開發上容易不自覺提高耦合度，採用很多不易反查的手法。
使用上會有種犧牲一些微前端的好處來換取架構上與撰寫上的便利，但又有點本末倒置，甚至有種不如別用微前端好的感覺。

### 我怎麼看微前端？

剛開始我接手時，其實根本沒有成功建立任何的微前端，我是從頭建制這整個架構。而建構微前端的過程也是經歷許多坡折，但既然面對了就必須做好，作為公司想要推行的一項主軸技術，我就有責任把它處理好。

後面我會把這來龍去脈和心酸血淚逐條逐項分享，讓想嘗試這架構的你可以少走點彎路，其中也包含很多就算不是實作微前端也會遇到的前端基礎建設問題，讓我們各個擊破吧！

## (二) 微前端面臨的議題

### 前期資訊查找與準備

當要採用一個技術前，第一步肯定是要做充分的資料收集與測試。我剛接手這個需求時，我第一步先把公司前端前手的研究進度重新閱覽一遍，並且嘗試建置 POC 專案，確認技術理解。我整理許多要面對的問題點，但說真的...資源少的可憐，理論與概念相當多，但真的有更實務的實作分析資源尤其少。

### 應用與應用間的溝通

當你把前端拆成不同的 bundle 這件事，同時也代表你就無法使用你平常習慣的「import module」，跨應用模組間的溝通就形成問題。

那微前端可以有哪些相互溝通的機制呢？如果不採用 iframe 為前提，其實 Web Site 的 global 是相同的，所以你操作的所有的記憶體位置也是共享的。這樣思考下來，似乎簡單不少，但全部的東西往 window 丟，似乎也不是什麼好作法。

### 模組共用問題

在開發程式時，我們工程時都知道要去「共用程式碼」，透過模組共用來達到降低整體的程式大小，減少寫重複的程式碼。

然而在微前端開發時，因為模組被切開了，你無法確保你所引用的套件能夠被共用。當然大可全部採用 AMD 打包模式將模組注入在 global，但會另外衍生作用域和版本管理的潛在議題。注入的時機點也成了另一個問題，因為初始化要是舊加載全部的 package 就有點多餘，所以要等「需要時」才加載。

### 全域單例狀態管理

所謂全域單例狀態就比如 history, i18n... 等等均是，這些資訊是必須統一並同步的，不會有特定應用單獨改變。最容易出問題的就是 history router，目前大多路由工具都自成狀態管理機，但卻不具備面向微前端應用場景的處理。如何管理、通知、同步這些狀態成為微前端的難題之一。

### 樣式管理問題

CSS 樣式本身是全域，本身並沒有 scope 概念，經常會到處污染。當微前端被載入時，如果還注入 style 到 head 就可能有污染的危險，如何管理這些一不小心就血流成河的樣式成為一個複雜的工程。

### CI/CD

微前端核心目的就是為了達到分散管理，讓每個應用與應用之間解耦。如何在 CI/CD 做好宣告與用和自動化版本管理成了一項繁雜的工程，要處理的基礎架構從打包到伺服器上跑的部署腳本都習習相關。

### 微前端真的這麼不堪嗎？

其實我覺得微前端確實很多問題，但其實都可以一個個問題各個擊破，選好方案，做好取捨，就可以有效管理。
