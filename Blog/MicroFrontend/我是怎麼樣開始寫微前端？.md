# 前端也可以搞微服務？！前端最複雜的一種架構

## (三) 我是怎麼樣開始寫微前端？

在進入解決方案篇章前，先來說說我身上發生什麼事，為什麼會開始玩微前端？剛開始是進入公司後，CTO 想要推行微前端，我就必須了解這一塊相關知識。雖然一直都知道什麼是微前端，但我還真沒有實際實作過。但也很開心有這樣的機會，我開始碰了這條路。

那可能就有人會好奇，為什麼公司會想要做微前端呢？

第一個原因，公司有多個前端框架同時運行。原本使用 Vue 2.6，但公司其他產品線都使用 React，長遠來說，其實是需要統一使用的技術線來降低維護成本的。但要一口氣重構轉換框架是一件曠時費力，而且成本非常高昂的工作。所以規劃後決定用 Migrate 的方式逐步重構，而這種重構方式，卻沒辦法做到換框架。基於這樣的麻煩背景，微前端就是一個解決方案。

第二個原因，我們很多產品在部分情境是要架在 Local 環境，所以依照需求不同的產品會有不同的功能組態，甚至可能因為很多即時的環境條件改變組態，如果全然依賴前端的 `.env` 作為判斷會需要重新打包，也沒辦法節約環境上基本的打包大小，甚至不容易管理落地核心的產品。

第三個原因，上頭希望能將產品打造成一個可擴充可延展的產品，希望能給第三方去追加功能。正因如此擴充性能是需要可以在客戶環境被動態掛載的，所以需要微前端這種極其動態自由的功能。

## (四) 微前端的溝通

在微前端中，跨應用溝通是一個非常麻煩的事，你沒辦法像平時習慣的一個 “import” 語法來傳遞共用。那到底在微前端怎麼做跨應用溝通呢？

其實我們可以知道，所有微前端其實都是運行在同一個 global 之下，所以只要在一樣的 global 就一定可以被溝通。

那這個 global 是誰？凡是在這個 website 下，singleton 的所有對象都可以是溝通媒介。舉凡，同一個 backend service 、同一個 window object、被定義為 singleton 的 object 都符合這個條件。

那有沒有具體方法呢？
其實我可以舉幾個常見的手法來說。

1. 使用套件來協助溝通，這樣不需要維護複雜的機制。常見的方法是使用 module federation 共用同一包狀態管理器，由它的內部機制來溝通。
2. 使用 browser 機制溝通。通過 EventTarget 來做事件派發，可以向 window, document … 等等物件來進行溝通。或是使用 broadcast channel, message event, service worker 等等方式觸發。搭配 localStorage, sessionStorage, cookie, … 等等方式進行資料傳遞。
3. 使用後端串接 web socket 來溝通，以後端作為溝通橋樑，將資料存在後端，並使用 ws 進行事件觸發。

其實說穿了，每個方法都很像，其實原理顯而易見。如果是你，你用什麼方式呢？

## (五) 模組共用問題

### Module Federation

很多人提到微前端，反射神經就會想到「Module Federation」，中文稱之「模塊聯邦」，以下簡稱 MF 。但 MF 並不是微前端「必要的」存在，甚至並不是一個 Framework ，它只是一種 bundle 的概念，也只是一個共享程式和共享記憶體的一種手段。

MF 是把各個套件的各個版本分散式存在每一個微服務端點，透過 entry point 的 map 確認是否曾經加載過，當曾經加載過特定版本的 module 之後，就不會重複加載，並且載入同一包被快取的 JavaScript 也可以共享記憶體。而這個機制便是 Webpack5 提供的一個打包機制，也是在微前端去解決「版本管理」、「模塊共享」、「記憶體共享」的關鍵機制，這也是為什麼很多人會把這兩個東西劃上等號。

反過來說，其實不使用 MF 也是能夠處理這樣的機制，但這就牽扯微前端的溝通框架，能否進行這樣的溝通和封裝。通常還是蠻仰賴 Bundle Tool 在預處理，否則處理起來實在是相當囉嗦。

模組共用是微前端在切分時，跟微服務最大的不同。前端是有流量上的消費，每一個客戶端都會造成伺服器一定的負擔，所以像是微服務單純的切分，微前端更要經常煩惱「共用」議題。

這又不得不提到 module federation ，MF 並不是一個套件，而是一種多模組的管理系統的思維，只是有套件實現了這種思維。

MF 的理念基本上貫穿所有「模組共用」的思維，使用多服務進入點管理多版本的 packages，具備版本識別與切分環境的能力，讓多個組態情境能良好管理各自的環境版本。
如果要細談 MF 可能完全可以開另一個篇章，所以就不打算在微前端篇章提及其實作與原理，還有其相關特性。

目前其實幾乎找不到比起 MF 更完善的其他解決方案，幾乎仰賴大量的基礎建設架構的實作實現，我個人還是建議就用吧。

但也不得不提及，一旦使用了 MF，模組化就會被綁定在 特定的 chunk system ，遷移上變成整個架構的成本。微前端雖然有分散部署的優點，但架構面的部分仰賴一致的規範與協定，如果一致的部分發生變動，那就會根本性的需要大幅度調整。
